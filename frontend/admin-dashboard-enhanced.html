<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Admin Dashboard - Complete Lead Management</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        .header {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        .header h1 {
            color: #2c3e50;
            font-size: 28px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .header .subtitle {
            color: #7f8c8d;
            font-size: 14px;
            margin-top: 5px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            transition: transform 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-2px);
        }
        .stat-card .label {
            color: #7f8c8d;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }
        .stat-card .value {
            font-size: 36px;
            font-weight: bold;
            color: #2c3e50;
            margin-top: 8px;
        }
        .stat-card .change {
            font-size: 12px;
            margin-top: 5px;
            color: #27ae60;
        }
        .leads-container {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        .table-header {
            padding: 25px;
            border-bottom: 2px solid #ecf0f1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
        }
        .table-wrapper {
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1400px;
        }
        thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px 10px;
            text-align: left;
            font-weight: 600;
            color: white;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        td {
            padding: 15px 10px;
            border-bottom: 1px solid #ecf0f1;
            font-size: 14px;
            color: #2c3e50;
        }
        tr:hover {
            background: #f8f9fa;
        }
        .tier-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
        }
        .tier-platinum { background: #e3f2fd; color: #1976d2; }
        .tier-gold { background: #fff3e0; color: #f57c00; }
        .tier-silver { background: #f5f5f5; color: #616161; }
        .tier-bronze { background: #efebe9; color: #6d4c41; }
        .tier-standard { background: #e8f5e9; color: #388e3c; }
        .tier-basic { background: #fce4ec; color: #c2185b; }
        
        .product-score {
            display: inline-block;
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            margin: 1px;
        }
        .score-high { background: #d4edda; color: #155724; }
        .score-medium { background: #fff3cd; color: #856404; }
        .score-low { background: #f8d7da; color: #721c24; }
        .score-nq { background: #e2e3e5; color: #6c757d; }
        
        .btn {
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-success {
            background: #27ae60;
            color: white;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .loading {
            text-align: center;
            padding: 60px;
            color: #7f8c8d;
        }
        .grade {
            font-weight: bold;
            padding: 3px 8px;
            border-radius: 4px;
        }
        .grade-a { background: #d4edda; color: #155724; }
        .grade-b { background: #fff3cd; color: #856404; }
        .grade-c { background: #cce5ff; color: #004085; }
        .grade-d { background: #f8d7da; color: #721c24; }
        
        .urgency-badge {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .urgency-immediate { background: #f8d7da; color: #721c24; }
        .urgency-planned { background: #fff3cd; color: #856404; }
        .urgency-flexible { background: #d1ecf1; color: #0c5460; }
        
        .doc-status {
            display: flex;
            gap: 5px;
            align-items: center;
        }
        .doc-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        .doc-uploaded { background: #27ae60; color: white; }
        .doc-pending { background: #e74c3c; color: white; }
        
        .expandable-row {
            cursor: pointer;
        }
        .expandable-row:hover {
            background: #f0f0f0;
        }
        .details-row {
            display: none;
            background: #f8f9fa;
        }
        .details-row.show {
            display: table-row;
        }
        .details-content {
            padding: 20px;
        }
        
        .filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .filter-input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        .filter-select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            background: white;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        .modal-content {
            background: white;
            margin: 50px auto;
            padding: 30px;
            border-radius: 15px;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal.show {
            display: block;
        }
        
        .ghl-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
        }
        .ghl-synced { background: #d4edda; color: #155724; }
        .ghl-pending { background: #fff3cd; color: #856404; }
        .ghl-failed { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="header">
        <h1>🚀 Enhanced Lead Management Dashboard</h1>
        <div class="subtitle">Complete view with multi-product scoring, documents, and CRM integration</div>
    </div>
    
    <div class="stats">
        <div class="stat-card">
            <div class="label">Total Leads</div>
            <div class="value" id="totalLeads">0</div>
            <div class="change" id="leadChange">+0 today</div>
        </div>
        <div class="stat-card">
            <div class="label">Qualified Leads</div>
            <div class="value" id="qualifiedLeads">0</div>
            <div class="change">High value opportunities</div>
        </div>
        <div class="stat-card">
            <div class="label">Average Score</div>
            <div class="value" id="avgScore">0</div>
            <div class="change">Across all products</div>
        </div>
        <div class="stat-card">
            <div class="label">Total Value</div>
            <div class="value" id="totalValue">$0</div>
            <div class="change">Estimated revenue</div>
        </div>
        <div class="stat-card">
            <div class="label">Documents</div>
            <div class="value" id="docStats">0%</div>
            <div class="change">Completion rate</div>
        </div>
        <div class="stat-card">
            <div class="label">GHL Synced</div>
            <div class="value" id="ghlStats">0</div>
            <div class="change">CRM integration</div>
        </div>
    </div>
    
    <div class="leads-container">
        <div class="table-header">
            <h2>Complete Lead Details</h2>
            <div>
                <button class="btn btn-success" onclick="exportToCSV()">📊 Export Full Data</button>
                <button class="btn btn-primary" onclick="loadLeads()">🔄 Refresh</button>
            </div>
        </div>
        
        <div style="padding: 20px;">
            <div class="filters">
                <input type="text" class="filter-input" placeholder="Search business..." id="searchInput" onkeyup="filterLeads()">
                <select class="filter-select" id="tierFilter" onchange="filterLeads()">
                    <option value="">All Tiers</option>
                    <option value="PLATINUM">Platinum</option>
                    <option value="GOLD">Gold</option>
                    <option value="SILVER">Silver</option>
                    <option value="BRONZE">Bronze</option>
                </select>
                <select class="filter-select" id="productFilter" onchange="filterLeads()">
                    <option value="">All Products</option>
                    <option value="mca">MCA Qualified</option>
                    <option value="termLoan">Term Loan Qualified</option>
                    <option value="sbaLoan">SBA Qualified</option>
                    <option value="lineOfCredit">LOC Qualified</option>
                    <option value="creditCardStacking">CC Stacking Qualified</option>
                </select>
            </div>
        </div>
        
        <div class="table-wrapper">
            <div id="tableContent">
                <div class="loading">Loading enhanced lead data...</div>
            </div>
        </div>
    </div>
    
    <!-- Lead Details Modal -->
    <div id="leadModal" class="modal">
        <div class="modal-content">
            <h2>Lead Complete Details</h2>
            <div id="modalContent"></div>
            <button class="btn btn-primary" onclick="closeModal()">Close</button>
        </div>
    </div>
    
    <script>
        // Use the correct API endpoint
        const API_URL = 'https://api.fidenta.io/api/leads';
        let allLeads = [];
        
        async function loadLeads() {
            try {
                const response = await fetch(API_URL);
                const data = await response.json();
                
                if (data.success) {
                    allLeads = data.leads;
                    displayLeads(allLeads);
                    updateStats(allLeads);
                }
            } catch (error) {
                console.error('Error loading leads:', error);
                document.getElementById('tableContent').innerHTML = 
                    '<div class="loading">Error loading leads. Trying to reconnect...</div>';
            }
        }
        
        function displayLeads(leads) {
            if (leads.length === 0) {
                document.getElementById('tableContent').innerHTML = 
                    '<div class="loading">No leads found. Submit some test leads!</div>';
                return;
            }
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Business</th>
                            <th>Contact</th>
                            <th>Industry</th>
                            <th>Monthly Revenue</th>
                            <th>Time in Biz</th>
                            <th>Credit</th>
                            <th>Loan Amount</th>
                            <th>Product Scores</th>
                            <th>Best Product</th>
                            <th>Est. Value</th>
                            <th>Documents</th>
                            <th>GHL Status</th>
                            <th>Urgency</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            leads.forEach(lead => {
                const date = new Date(lead.createdAt).toLocaleDateString();
                const monthlyRevenue = lead.monthlyRevenue || (lead.annualRevenue ? Math.round(lead.annualRevenue / 12) : 0);
                
                // Product scores display
                let productScoresHtml = '';
                if (lead.productScores) {
                    Object.entries(lead.productScores).forEach(([product, data]) => {
                        if (data.qualified && data.score > 0) {
                            const scoreClass = data.score >= 80 ? 'score-high' : 
                                              data.score >= 60 ? 'score-medium' : 
                                              data.score >= 40 ? 'score-low' : 'score-nq';
                            productScoresHtml += `<span class="product-score ${scoreClass}">${product.substring(0,3).toUpperCase()}:${data.grade}</span>`;
                        }
                    });
                } else {
                    productScoresHtml = `<span class="product-score score-medium">Legacy:${lead.leadGrade || 'N/A'}</span>`;
                }
                
                // Document status
                const hasDocuments = lead.bankStatementsUploaded || lead.taxReturnsUploaded;
                const docHtml = `
                    <div class="doc-status">
                        <span class="doc-icon ${lead.bankStatementsUploaded ? 'doc-uploaded' : 'doc-pending'}">B</span>
                        <span class="doc-icon ${lead.taxReturnsUploaded ? 'doc-uploaded' : 'doc-pending'}">T</span>
                    </div>
                `;
                
                // GHL Status
                const ghlStatus = lead.ghlSyncStatus || 'pending';
                const ghlClass = `ghl-${ghlStatus}`;
                
                // Urgency styling
                const urgencyClass = lead.urgency === 'Immediate' ? 'urgency-immediate' :
                                   lead.urgency === 'Planned' ? 'urgency-planned' : 'urgency-flexible';
                
                // Grade styling
                const gradeClass = lead.leadGrade && lead.leadGrade.startsWith('A') ? 'grade-a' :
                                 lead.leadGrade && lead.leadGrade.startsWith('B') ? 'grade-b' :
                                 lead.leadGrade && lead.leadGrade.startsWith('C') ? 'grade-c' : 'grade-d';
                
                html += `
                    <tr class="expandable-row" onclick="showLeadDetails('${lead._id}')">
                        <td>${date}</td>
                        <td><strong>${lead.businessName}</strong></td>
                        <td>${lead.contactName}<br><small>${lead.email}</small></td>
                        <td>${lead.industry || 'N/A'}</td>
                        <td>$${monthlyRevenue.toLocaleString()}</td>
                        <td>${lead.monthsInBusiness || 0} mo</td>
                        <td>${lead.creditScore || 'N/A'}</td>
                        <td>$${(lead.loanAmount || 0).toLocaleString()}</td>
                        <td>${productScoresHtml}</td>
                        <td>${lead.routing?.recommendedProduct || lead.leadGrade || 'N/A'}</td>
                        <td><strong>$${lead.routing?.estimatedValue || '10'}</strong></td>
                        <td>${docHtml}</td>
                        <td><span class="ghl-status ${ghlClass}">${ghlStatus}</span></td>
                        <td><span class="urgency-badge ${urgencyClass}">${lead.urgency || 'Flexible'}</span></td>
                        <td>
                            <button class="btn btn-primary" style="padding: 5px 10px; font-size: 12px;" onclick="viewFullDetails(event, '${lead._id}')">View</button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            document.getElementById('tableContent').innerHTML = html;
        }
        
        function updateStats(leads) {
            // Total leads
            document.getElementById('totalLeads').textContent = leads.length;
            
            // Today's leads
            const today = new Date().toDateString();
            const todayCount = leads.filter(lead => 
                new Date(lead.createdAt).toDateString() === today
            ).length;
            document.getElementById('leadChange').textContent = `+${todayCount} today`;
            
            // Qualified leads (high value)
            const qualifiedCount = leads.filter(lead => {
                const value = lead.routing?.estimatedValue || 0;
                return value >= 75;
            }).length;
            document.getElementById('qualifiedLeads').textContent = qualifiedCount;
            
            // Average score
            const avgScore = leads.length > 0 
                ? Math.round(leads.reduce((sum, lead) => sum + (lead.leadScore || 0), 0) / leads.length)
                : 0;
            document.getElementById('avgScore').textContent = avgScore;
            
            // Total potential value
            const totalValue = leads.reduce((sum, lead) => {
                return sum + (lead.routing?.estimatedValue || 10);
            }, 0);
            document.getElementById('totalValue').textContent = '$' + totalValue.toLocaleString();
            
            // Document completion rate
            const docsComplete = leads.filter(lead => 
                lead.bankStatementsUploaded || lead.taxReturnsUploaded
            ).length;
            const docRate = leads.length > 0 ? Math.round((docsComplete / leads.length) * 100) : 0;
            document.getElementById('docStats').textContent = docRate + '%';
            
            // GHL sync status
            const ghlSynced = leads.filter(lead => lead.ghlSyncStatus === 'synced').length;
            document.getElementById('ghlStats').textContent = ghlSynced + '/' + leads.length;
        }
        
        function filterLeads() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const tierFilter = document.getElementById('tierFilter').value;
            const productFilter = document.getElementById('productFilter').value;
            
            let filteredLeads = allLeads.filter(lead => {
                // Search filter
                const matchesSearch = !searchTerm || 
                    lead.businessName.toLowerCase().includes(searchTerm) ||
                    lead.contactName.toLowerCase().includes(searchTerm) ||
                    lead.email.toLowerCase().includes(searchTerm);
                
                // Tier filter
                const matchesTier = !tierFilter || lead.scoringTier === tierFilter;
                
                // Product filter
                let matchesProduct = !productFilter;
                if (productFilter && lead.productScores) {
                    const productData = lead.productScores[productFilter];
                    matchesProduct = productData && productData.qualified && productData.score > 0;
                }
                
                return matchesSearch && matchesTier && matchesProduct;
            });
            
            displayLeads(filteredLeads);
        }
        
        function viewFullDetails(event, leadId) {
            event.stopPropagation();
            const lead = allLeads.find(l => l._id === leadId);
            if (!lead) return;
            
            let detailsHtml = `
                <h3>${lead.businessName}</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h4>Contact Information</h4>
                        <p><strong>Contact:</strong> ${lead.contactName}</p>
                        <p><strong>Email:</strong> ${lead.email}</p>
                        <p><strong>Phone:</strong> ${lead.phone}</p>
                        <p><strong>Address:</strong> ${lead.city || ''} ${lead.state || ''} ${lead.zipCode || ''}</p>
                    </div>
                    <div>
                        <h4>Business Information</h4>
                        <p><strong>Industry:</strong> ${lead.industry || 'N/A'}</p>
                        <p><strong>Monthly Revenue:</strong> $${(lead.monthlyRevenue || 0).toLocaleString()}</p>
                        <p><strong>Annual Revenue:</strong> $${(lead.annualRevenue || 0).toLocaleString()}</p>
                        <p><strong>Time in Business:</strong> ${lead.monthsInBusiness || 0} months</p>
                    </div>
                </div>
                
                <h4 style="margin-top: 20px;">Multi-Product Scoring Results</h4>
            `;
            
            if (lead.productScores) {
                detailsHtml += '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">';
                Object.entries(lead.productScores).forEach(([product, data]) => {
                    const bgColor = data.qualified && data.score > 0 ? '#d4edda' : '#f8d7da';
                    detailsHtml += `
                        <div style="padding: 10px; background: ${bgColor}; border-radius: 8px;">
                            <strong>${product}:</strong><br>
                            Score: ${data.score}<br>
                            Grade: ${data.grade}<br>
                            ${data.qualified ? '✅ Qualified' : '❌ Not Qualified'}
                        </div>
                    `;
                });
                detailsHtml += '</div>';
            }
            
            if (lead.routing) {
                detailsHtml += `
                    <h4 style="margin-top: 20px;">Routing Information</h4>
                    <p><strong>Recommended Product:</strong> ${lead.routing.recommendedProduct}</p>
                    <p><strong>Estimated Value:</strong> $${lead.routing.estimatedValue}</p>
                    <p><strong>Credit Repair Candidate:</strong> ${lead.routing.creditRepairCandidate ? 'Yes' : 'No'}</p>
                    <p><strong>Qualified Products:</strong> ${lead.routing.qualifiedProducts?.join(', ') || 'None'}</p>
                `;
            }
            
            detailsHtml += `
                <h4 style="margin-top: 20px;">Tracking Information</h4>
                <p><strong>Lead ID:</strong> ${lead._id}</p>
                <p><strong>Created:</strong> ${new Date(lead.createdAt).toLocaleString()}</p>
                <p><strong>Source:</strong> ${lead.source || 'Website'}</p>
                <p><strong>IP Address:</strong> ${lead.ipAddress || 'N/A'}</p>
            `;
            
            document.getElementById('modalContent').innerHTML = detailsHtml;
            document.getElementById('leadModal').classList.add('show');
        }
        
        function closeModal() {
            document.getElementById('leadModal').classList.remove('show');
        }
        
        function showLeadDetails(leadId) {
            // This could expand inline details or show a quick preview
            console.log('Quick preview for lead:', leadId);
        }
        
        function exportToCSV() {
            if (allLeads.length === 0) {
                alert('No leads to export');
                return;
            }
            
            // Enhanced CSV with all fields
            const headers = [
                'Date', 'Business Name', 'Contact Name', 'Email', 'Phone',
                'Industry', 'Monthly Revenue', 'Annual Revenue', 'Months in Business',
                'Credit Score', 'Loan Amount', 'Urgency',
                'Overall Score', 'Overall Grade', 'Tier',
                'MCA Score', 'MCA Grade', 'Term Loan Score', 'Term Loan Grade',
                'SBA Score', 'SBA Grade', 'LOC Score', 'LOC Grade',
                'CC Stacking Score', 'CC Stacking Grade',
                'Recommended Product', 'Estimated Value', 'Qualified Products',
                'Bank Statements', 'Tax Returns', 'GHL Status',
                'City', 'State', 'Zip Code'
            ];
            
            const rows = allLeads.map(lead => {
                const productScores = lead.productScores || {};
                return [
                    new Date(lead.createdAt).toLocaleDateString(),
                    lead.businessName,
                    lead.contactName,
                    lead.email,
                    lead.phone,
                    lead.industry || '',
                    lead.monthlyRevenue || '',
                    lead.annualRevenue || '',
                    lead.monthsInBusiness || '',
                    lead.creditScore || '',
                    lead.loanAmount || '',
                    lead.urgency || '',
                    lead.leadScore || '',
                    lead.leadGrade || '',
                    lead.scoringTier || '',
                    productScores.mca?.score || '',
                    productScores.mca?.grade || '',
                    productScores.termLoan?.score || '',
                    productScores.termLoan?.grade || '',
                    productScores.sbaLoan?.score || '',
                    productScores.sbaLoan?.grade || '',
                    productScores.lineOfCredit?.score || '',
                    productScores.lineOfCredit?.grade || '',
                    productScores.creditCardStacking?.score || '',
                    productScores.creditCardStacking?.grade || '',
                    lead.routing?.recommendedProduct || '',
                    lead.routing?.estimatedValue || '',
                    lead.routing?.qualifiedProducts?.join('; ') || '',
                    lead.bankStatementsUploaded ? 'Yes' : 'No',
                    lead.taxReturnsUploaded ? 'Yes' : 'No',
                    lead.ghlSyncStatus || 'pending',
                    lead.city || '',
                    lead.state || '',
                    lead.zipCode || ''
                ];
            });
            
            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `leads-export-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }
        
        // Load leads on page load
        loadLeads();
        
        // Auto-refresh every 30 seconds
        setInterval(loadLeads, 30000);
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target == document.getElementById('leadModal')) {
                closeModal();
            }
        }
    </script>
</body>
</html>